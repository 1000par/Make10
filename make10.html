<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Make10メーカー</title>
<style>
body {
  font-family: sans-serif;
  padding: 20px;
}
input {
  width: 100%;
  padding: 8px;
  margin-bottom: 10px;
}
button {
  padding: 8px 12px;
}
#result {
  margin-top: 15px;
  font-weight: bold;
}
</style>
</head>
<body>

<h2 style="text-align: center;">【Make10メーカー】<br>四則演算で指定の数を作る</h2>
<div style="text-align: right; font-size: 0.9em; color: #555;">1000par 制作</div>
<div>
  <label for="target">作る数: </label>
  <input type="number" id="target" value="10" placeholder="例: 10">
</div>

<div>
  <label for="numbers">数字(スペース区切りで入力してください): </label>
  <input type="text" id="numbers" value="1 1 5 8" placeholder="例: 1 1 5 8">
</div>

<button onclick="readNumbers()">実行</button>

<div>
  <label for="progress">探索進行度: </label>
  <progress id="progress" value="0" max="10000000" style="width: 300px;"></progress>
  <span id="progressText">0 / 10000000</span>
</div>

<p id="result"></p>
<p id="output"></p>

<script>
const MAX_SOLUTIONS = 1000;
const MAX_TRIES = 10000000;

let solutions = new Set();
let tries = 0;

const progressBar = document.getElementById("progress");
const progressText = document.getElementById("progressText");

async function readNumbers() {
  solutions = new Set();
  tries = 0;
  const input = document.getElementById("numbers").value;
  const target = Number(document.getElementById("target").value);

  const arr = input.trim().split(/\s+/)
    .map(Number)
    .filter(n => !isNaN(n))
    .map(n => ({ value: n, expr: n.toString() }));

  document.getElementById("result").textContent =
    "入力された配列: [" + arr.map(x=>x.value).join(", ") + "]";

  document.getElementById("output").innerText = "";
  await isEnableMakeValueAsync(arr, target);
  
  let text = "";

  if (solutions.size > 0 && solutions.size < MAX_SOLUTIONS && tries < MAX_TRIES) {
    text += "全ての解が見つかりました！\n";
  }

  if (solutions.size === 0) {
    if (tries < MAX_TRIES) text += "作れません\n";
  } else {
    text += "見つかった式:\n" +
        [...solutions].map(s => s + "=" + target).join("\n");

    if (solutions.size >= MAX_SOLUTIONS) {
      text += `\n\n※${MAX_SOLUTIONS}個の解で打ち切りました`;
    }
  }

  if (tries >= MAX_TRIES) {
    text += `\n\n※探索数が${MAX_TRIES}に達したため打ち切りました`;
  }

  // まとめて出力
  progressBar.value = tries;
  progressText.textContent = `${tries} / ${MAX_TRIES}`;
  document.getElementById("output").innerText = text;
}
async function isEnableMakeValueAsync(arr, target){
  if (tries >= MAX_TRIES) return;
  tries++;
  
  progressBar.value = tries;
  progressText.textContent = `${tries} / ${MAX_TRIES}`;
  if (solutions.size >= MAX_SOLUTIONS) return;

  if (arr.length === 1) {
    if (Math.abs(arr[0].value - target) < 1e-9) {
      solutions.add(arr[0].expr);
    }
    return;
  }

  for (let i = 0; i < arr.length; i++) {
    for (let j = i + 1; j < arr.length; j++) {

      const a = arr[i];
      const b = arr[j];

      const rest = arr.filter((_, idx) => idx !== i && idx !== j);

      const candidates = [
        { value: a.value + b.value, expr: `(${a.expr}+${b.expr})` },
        { value: a.value - b.value, expr: `(${a.expr}-${b.expr})` },
        { value: b.value - a.value, expr: `(${b.expr}-${a.expr})` },
        { value: a.value * b.value, expr: `(${a.expr}×${b.expr})` }
      ];

      if (b.value !== 0)
        candidates.push({ value: a.value / b.value, expr: `(${a.expr}÷${b.expr})` });

      if (a.value !== 0)
        candidates.push({ value: b.value / a.value, expr: `(${b.expr}÷${a.expr})` });

      for (let c of candidates) {
        if (tries % 100000 === 0) {
          await new Promise(resolve => setTimeout(resolve, 0));
        }
        await isEnableMakeValueAsync([...rest, c], target);
      }
    }
  }
}
</script>

</body>
</html>